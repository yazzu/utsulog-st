services:
  utsulog-st:
    build: .
    container_name: utsulog-st
    working_dir: /app
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - VIDEOFILES_DIR=/app/data/videofiles
      - AUDIOS_DIR=/app/data/audios
      - VIDEOS_NDJSON=/app/data/videos/videos.ndjson # 動画リストNDJSON
    volumes:
      # 現在のディレクトリをコンテナ内の /app にマウント
      - .:/app
      # Hugging Faceのモデルキャッシュを永続化（再ダウンロード防止）
      - hf_cache:/root/.cache/huggingface
      - /mnt/f/Dev/utsulog/videofiles:/app/data/videofiles
      - /mnt/f/Dev/utsulog/videos:/app/data/videos # 動画リストNDJSON保存用
      - /mnt/miniutsuro/utsulog-data/videofiles:/mnt/miniutsuro/utsulog-data/videofiles:ro # sambaネットワークフォルダ（読み取り専用）
    # 起動し続けるように設定
    tty: true
    stdin_open: true
    # GPUを使用するための設定 (NVIDIA Container Toolkitが必要)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

volumes:
  hf_cache:
